<?php
// $Id$

/**
 * @file
 * Integration with Lingwo Dictionary API.
 */

/**
 * content_type based implemantation:
 */

// TODO: Is this the right place/way to do this?
module_load_include('inc', 'lingwo_dictionary', 'types/entry');

/**
 * Implementation of hook_node_info().
 */
function lingwo_dictionary_node_info() {
  return array(
    'lingwo_dictionary_entry' => array(
      'name' => t('Dictionary Entry'),
      'module' => 'lingwo_dictionary_entry',
      'description' => t('This represents a dictionary entry.'),
      'has_title' => TRUE,
      'title_label' => t('Headword'),
      'has_body' => FALSE,
    ),
  );
}

/**
 * Implementation of hook_access().
 */
function lingwo_dictionary_access($op, $node, $account) {
  // TODO: break up for the different content types.
  if ($op == 'create') {
    return user_access('create lingwo_dictionary content', $account);
  }

  if ($op == 'update') {
    if (user_access('edit any lingwo_dictionary content', $account) || (user_access('edit own lingwo_dictionary content', $account) && ($account->uid == $node->uid))) {
      return TRUE;
    }
  }

  if ($op == 'delete') {
    if (user_access('delete any lingwo_dictionary content', $account) || (user_access('delete own lingwo_dictionary content', $account) && ($account->uid == $node->uid))) {
      return TRUE;
    }
  }
}

/**
 * Implementation of hook_perm().
 */
function lingwo_dictionary_perm() {
  // TODO: make useful, smart.
  return array(
    'create lingwo_dictionary content',
    'delete own lingwo_dictionary content',
    'delete any lingwo_dictionary content',
    'edit own lingwo_dictionary content',
    'edit any lingwo_dictionary content',
  );
}

/**
 * Implementation of hook_nodeapi().
 */
function lingwo_dictionary_entry_nodeapi(&$node, $op, $teaser, $page) {
  $type = node_get_types($node);
  switch ($op) {
    case 'delete revision':
	  $func = $type .'_delete_revision';
	  $func($name);
      break;
  }
};

/**
 * Implementation of hook_help
 */
function lingwo_dictionary_help($path, $arg) {
  $output = '';
  switch ($path) {
    case 'admin/help#lingwo_dictionary':
      $output = '<p>'. t('Create a multilingual dictionary with Drupal.') .'</p>';
      break;
  }
  return $output;
}

/**
 * Implementation of hook_block
 */
function lingwo_dictionary_block($op = 'list', $delta = 0) {
  if ($op == 'list') {
    $block[0]['info'] = t('Search Dictionary');
    return $block;
  }
  else if ($op == 'view') {
	module_load_include('inc', 'lingwo_dictionary', 'pages/lingwo_dictionary.entry.inc');
    $block['subject'] = t('Search Dictionary');
    $block['content'] = drupal_get_form('lingwo_dictionary_search_form');
    return $block;
  }
}

/**
 * Implementation of hook_menu().
 */
function lingwo_dictionary_menu() {
  $items = array();
  $items['admin/settings/lingwo_dictionary'] = array(
    'title' => 'Lingwo Dictionary',
    'description' => t('Settings for Lingwo Dictionary integration module.'),
    'access arguments' => array('administer site configuration'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('lingwo_dictionary_admin_settings'),
    'file' => 'pages/lingwo_dictionary.admin.inc',
    'type' => MENU_NORMAL_ITEM
  );

  /*
  if ($lookup_path = lingwo_dictionary_lookup_path()) {
    $items[$lookup_path .'/%/%'] = array(
      'page callback' => 'lingwo_dictionary_lookup_page',
      'page arguments' => array(1, 2),
      'access arguments' => array('access lingwo_dictionary content'),
      'file' => 'pages/lingwo_dictionary.entry.inc',
      'type' => MENU_CALLBACK
    );
  }
  */
  return $items;
}


/**
 * Implementation of hook_forms().
 */
function lingwo_dictionary_forms() {
  $form_names = array(
    'search',
  );

  foreach ($form_names as $name) {
    $forms['lingwo_dictionary_'. $name .'_form'] = array(
      'callback' => 'lingwo_dictionary_'. $name .'_form'
    );
  }
  return $forms;
}

/**
 * Implementation of hook_theme().
 */
function lingwo_dictionary_theme() {
  return array(
    'lingwo_dictionary_entry_senses_form' => array(
      'file' => 'types/entry.inc',
      'arguments' => array('form' => NULL),
    ),

	/*
    'lingwo_dictionary_language_list' => array(
      'file' => 'pages/lingwo_dictionary.lang.inc',
      'arguments' => array('languages' => NULL),
    ),
    'lingwo_dictionary_entry' => array(
      'file' => 'pages/lingwo_dictionary.entry.inc',
      'arguments' => array('entry' => NULL),
    ),
    'lingwo_dictionary_trans_edit_senses' => array(
      'file' => 'pages/lingwo_dictionary.trans.inc',
      'arguments' => array('form' => NULL),
    ),
    'lingwo_dictionary_translation' => array(
      'file' => 'pages/lingwo_dictionary.trans.inc',
      'arguments' => array('entry' => NULL, 'trans' => NULL),
    ),
    'lingwo_dictionary_entry_heading' => array(
      'file' => 'pages/lingwo_dictionary.trans.inc',
      'arguments' => array('entry' => NULL),
    ),
    'lingwo_dictionary_senses_widget' => array(
      'arguments' => array('element' => NULL),
    ),
	*/
  );
}

/*
 * Settings
 */

/**
 * Drupal path for dictionary lookup.
 */
function lingwo_dictionary_lookup_path($value = NULL) {
  if (is_null($value)) {
    return variable_get('lingwo_dictionary_lookup_path', 'lookup');
  }
  variable_set('lingwo_dictionary_lookup_path', $value);
}

/**
 * What 404 error settings are set?
 */
function lingwo_dictionary_404_type($value = NULL) {
  if (is_null($value)) {
    return variable_get('lingow_dictionary_404_type', array('Link to similar', 'Creation form'));
  }
  variable_set('lingow_dictionary_404_type', $values);
}

/**
 * Various lingwo_dictionary options.
 */
function lingwo_dictionary_options($value = NULL) {
  if (is_null($value)) {
    return variable_get('lingwo_dictionary_options', array('entry edit', 'search similar', 'view revisions'));
  }
  return variable_set('lingwo_dictionary_options', $value);
}

/**
 * Is entry editting enabled?
 */
function lingwo_dictionary_entry_edit() {
  $options = lingwo_dictionary_options();
  return $options['entry edit'];
}

/**
 * Is searching for similar entries enabled?
 */
function lingwo_dictionary_search_similar() {
  $options = lingwo_dictionary_options();
  return $options['search similar'];
}

/**
 * Is revision viewing enabled?
 */
function lingwo_dictionary_view_revisions() {
  $options = lingwo_dictionary_options();
  return $options['view revisions'];
}

