<?php

module_load_include('inc', 'lingwo_dictionary', 'lingwo_dictionary.test');

class LingwoFieldsTestCase extends LingwoDictionaryWebTestCase {
  public static function getInfo() {
    return array(
      'name' => 'lingwo_fields',
      'description' => 'Testing the web functionality provided by lingwo_fields.',
      'group' => 'Lingwo Dictionary',
    );
  }

  public function setUp() {
    parent::setUp('content', 'ahah_helper', 'lingwo_language', 'lingwo_fields');

    $this->createField(array(
      'label'       => 'Fields',
      'field_name'  => 'fields',
      'type'        => 'lingwo_fields',
      'widget_type' => 'lingwo_fields_widget',
      'multiple'    => 1
    ));
  }

  # Checks that we can load the fields for a language/pos and save them normally.
  # Also checks for the presense of a bug that existed in early implementations:
  #  (1) CCK would attempt to save empty fields causing database errors.
  public function testCreate() {
    $entry_type = _lingwo_dictionary_settings('entry_content_type');

    // get that the create page is all good
    $this->drupalGet('node/add/'. $entry_type);

    // set the language and pos, then refresh the fields
    $edit = $this->getEntryEdit(array(
        'headword' => 'czerwony',
        'language' => 'pl',
        'pos' => 'adjective',
    ));
    $this->drupalPost(NULL, $edit, 'Refresh');
    // check that the fields have appeared
    $this->assertFieldByName('field_fields[1][name]', '*stem');
    $this->assertFieldByName('field_fields[1][type]', 'form');
    $this->assertFieldByName('field_fields[1][automatic]', TRUE);
    $this->assertFieldByName('field_fields[1][value]');

    // set the stem
    $edit['field_fields[1][value]'] = 'czerwonXYZ';
    $edit['field_fields[1][automatic]'] = FALSE;
    $this->drupalPost(NULL, $edit, 'Save');
    $this->assertText(t('@type czerwony has been created.', array('@type' => $entry_type)));
    // check for the field!!!
    $this->assertText("*stem: \n czerwonXYZ");

    // go to the edit page again
    $nid = lingwo_dictionary_entry_lookup('czerwony', 'pl', 'adjective');
    $this->drupalGet("node/$nid/edit");
    $this->assertFieldByName('field_fields[1][value]', 'czerwonXYZ');
    $this->assertFieldByName('field_fields[1][automatic]', FALSE);
  }

  public function testCreateEmpty() {
    $entry_type = _lingwo_dictionary_settings('entry_content_type');

    // get that the create page is all good
    $this->drupalGet('node/add/'. $entry_type);

    // create an Entry
    $entry = array(
      'headword' => 'test',
      'language' => 'zzz',
      'pos' => 'adjective',
    );
    $this->createEntry($entry);
    $this->assertText(t('@type test has been created.', array('@type' => $entry_type)));
    // CCK empty-ness bug
    $this->assertNoRaw('Column &amp;#039;field_fields_type&amp;#039; cannot be null');
  }

  // This is basically the same test from lingwo_dictionary.test again, but there are problems
  // with it when lingwo_fields is enabled.
  // TODO: We have to call the AHAH submit handler to get this problem to happen.
  /*
  public function testValidationConflict() {
    $entry_type = _lingwo_dictionary_settings('entry_content_type');

    $entry = array(
      'headword' => 'czerwony',
      'language' => 'pl',
      'pos' => 'adjective',
    );

    // Create the first time
    $this->createEntry($entry);
    $this->assertText(t('@type czerwony has been created.', array('@type' => $entry_type)));

    // Try to create a second time (and get a duplicate!)
    $this->createEntry($entry);
    $this->assertText(t('Entry with this language, part of speech and headword combination already exists: @name', array('@name' => $entry['name'])));

    // Modifying the part of speech should be enough to allow it to be created
    $entry['pos'] = 'noun';
    $this->createEntry($entry);
    $this->assertText(t('@type czerwony has been created.', array('@type' => $entry_type)));
  }
  */
}

